---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: metadata-svc
  labels:
    app: metadata-svc
spec:
  replicas: 1
  selector:
    matchLabels:
      app: metadata-svc
  template:
    metadata:
      labels:
        app: metadata-svc
    spec:
      serviceAccountName: metadata-svc-sa
      shareProcessNamespace: true
      containers:
      # OpenBao Agent Sidecar
      - name: bao-agent
        image: openbao/openbao:2.1.1-dev
        command: ["bao", "agent", "-config=/etc/bao/config/agent.hcl"]
        volumeMounts:
        - name: bao-config
          mountPath: /etc/bao/config
        - name: bao-role-id
          mountPath: /etc/bao/role-id
          subPath: role-id
        - name: bao-secret-id
          mountPath: /etc/bao/secret-id
          subPath: secret-id
        - name: bao-ca
          mountPath: /etc/bao/ca
        - name: bao-agent-token
          mountPath: /home/bao
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"

      # Main Metadata Service Container
      - name: metadata-svc
        image: metadata-svc:latest
        imagePullPolicy: Never
        ports:
        - containerPort: 443
        env:
        - name: CONFIG_PATH
          value: "/app/config/metadataConfig.json"
        - name: NATS_URL
          value: "tls://nats.nats.svc.cluster.local:4222"
        - name: VAULT_AGENT_ADDR
          value: "http://127.0.0.1:8100"
        volumeMounts:
        - name: metadata-config
          mountPath: /app/config
        - name: avro-schemas
          mountPath: /app/schemas
        - name: shared-secrets
          mountPath: /app/secrets
        - name: client-certs
          mountPath: /app/certs/client
        - name: nats-ca-certs
          mountPath: /app/certs/nats
        - name: nats-client-tls
          mountPath: /app/certs/nats-client
        - name: bao-agent-token
          mountPath: /home/bao
        resources:
          requests:
            memory: "512Mi"
            cpu: "200m"
          limits:
            memory: "1Gi"
            cpu: "500m"

      # Certificate Hot Reload Sidecar for NATS
      - name: cert-reloader
        image: alpine:latest
        command:
        - /bin/sh
        - -c
        - |
          apk add --no-cache inotify-tools curl
          echo "Watching for NATS certificate changes..."
          while true; do
            inotifywait -e modify,create,delete /app/certs/nats-client/tls.crt /app/certs/nats/ca.crt
            echo "NATS certificate change detected, notifying metadata service"
            curl -X POST http://localhost:8080/reload-nats-certificates || true
            sleep 1
          done
        volumeMounts:
        - name: nats-client-tls
          mountPath: /app/certs/nats-client
        - name: nats-ca-certs
          mountPath: /app/certs/nats

      volumes:
      - name: bao-config
        configMap:
          name: bao-agent-config
      - name: bao-role-id
        secret:
          secretName: metadata-bao-approle
      - name: bao-secret-id
        secret:
          secretName: metadata-bao-approle  
      - name: bao-ca
        secret:
          secretName: openbao-ca-secret
      - name: bao-agent-token
        persistentVolumeClaim:
          claimName: bao-agent-token-pvc
      - name: metadata-config
        configMap:
          name: metadata-configmap
      - name: avro-schemas
        configMap:
          name: avro-schemas
      - name: shared-secrets
        persistentVolumeClaim:
          claimName: shared-secrets-pvc
      - name: client-certs
        persistentVolumeClaim:
          claimName: client-certs-pvc
      - name: nats-ca-certs
        secret:
          secretName: nats-ca-secret
      - name: nats-client-tls
        secret:
          secretName: metadata-nats-credential
