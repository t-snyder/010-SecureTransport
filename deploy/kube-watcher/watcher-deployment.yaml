apiVersion: apps/v1
kind: Deployment
metadata:
  name: watcher
  namespace: nats
  labels:
    app: watcher
spec:
  replicas: 1
  selector:
    matchLabels:
      app: watcher
  template:
    metadata:
      labels:
        app: watcher
    spec:
      serviceAccountName: watcher-sa
      securityContext:
        runAsNonRoot: true
        fsGroup: 1000

      volumes:
      # Vault Authentication AppRole info for watcher
      - name: watcher-bao-approle
        projected:
          sources:
          - secret:
              name: watcher-bao-approle
              items:
              - key: role-id
                path: role-id
              - key: secret-id
                path: secret-id
      - name: watcher-bao-agent-config
        configMap:
          name: watcher-bao-agent-config
          items:
            - key: agent.hcl
              path: agent.hcl
      - name: watcher-bao-token
        emptyDir: {}

      # NATS-specific volumes (replacing Pulsar volumes)
      - name: nats-bao-approle
        secret:
          secretName: nats-bao-approle
          items:
            - key: role-id
              path: role-id
            - key: secret-id
              path: secret-id
      - name: nats-bao-agent-config
        configMap:
          name: nats-bao-agent-config
          items:
            - key: agent.hcl
              path: agent.hcl
      - name: nats-bao-token
        emptyDir: {}
      - name: nats-bao-agent-cache
        emptyDir:
          sizeLimit: "50Mi"
      - name: watcher-bao-agent-cache
        emptyDir:
          sizeLimit: "50Mi"

      # CA bundle for client Vault TLS connection
      - name: openbao-ca
        projected:
          sources:
          - secret:
              name: openbao-ca-secret
              items:
              - key: ca.crt
                path: ca.crt

      # NATS CA bundle (replacing Pulsar CA)
      - name: nats-ca
        secret:
          secretName: nats-ca-tls
          items:
          - key: ca.crt
            path: ca.crt 
  
      # NATS client certificates (replacing proxy certs)
      - name: nats-client-certs
        secret:
          secretName: "watcher-nats-credential"
          items:
          - key: tls.crt
            path: tls.crt
          - key: tls.key
            path: tls.key

      - name: watcher-config
        configMap:
          name: watcher-config
      - name: avro-schemas
        configMap:
          name: avro-schemas 
      - name: client-certs
        emptyDir: {}

      containers:
      # Watcher OpenBao Agent
      - name: watcher-bao-agent
        image: openbao/openbao:latest  
        imagePullPolicy: IfNotPresent

        securityContext:
          runAsUser: 1000
          runAsGroup: 1000
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL

        volumeMounts:
        - name: watcher-bao-approle
          mountPath: /etc/bao/watcher
        - name: watcher-bao-agent-config
          mountPath: /etc/bao-agent
          readOnly: true
        - name: openbao-ca
          mountPath: /etc/bao/ca
          readOnly: true
        - name: watcher-bao-token
          mountPath: /home/bao/watcher
        - name: watcher-bao-agent-cache
          mountPath: /home/bao/watcher/cache

        command: ["bao", "agent", "-config=/etc/bao-agent/agent.hcl"]
        env:
        - name: VAULT_LOG_LEVEL
          value: "info"

      # NATS OpenBao Agent (replacing Pulsar agent)
      - name: nats-bao-agent
        image: openbao/openbao:latest
        imagePullPolicy: IfNotPresent

        securityContext:
          runAsUser: 1000
          runAsGroup: 1000
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL

        volumeMounts:
        - name: nats-bao-approle
          mountPath: /etc/bao/nats
        - name: nats-bao-token
          mountPath: /home/bao/nats
        - name: nats-bao-agent-config
          mountPath: /etc/bao-agent
        - name: openbao-ca
          mountPath: /etc/bao/ca
        - name: nats-bao-agent-cache
          mountPath: /home/bao/nats/cache

        command: ["bao", "agent", "-config=/etc/bao-agent/agent.hcl"]

      # Certificate Hot Reload Sidecar for NATS
      - name: cert-reloader
        image: alpine:latest
        command:
        - /bin/sh
        - -c
        - |
          apk add --no-cache inotify-tools curl
          echo "Watching for NATS certificate changes..."
          while true; do
            inotifywait -e modify,create,delete /app/certs/nats-client/tls.crt /app/certs/nats/ca.crt
            echo "NATS certificate change detected, notifying watcher service"
            curl -X POST http://localhost:8080/reload-nats-certificates || true
            sleep 1
          done
        volumeMounts:
        - name: nats-client-certs
          mountPath: /app/certs/nats-client
        - name: nats-ca
          mountPath: /app/certs/nats

      # Main Watcher Container
      - name: watcher
        image: library/watcher:1.0
        imagePullPolicy: IfNotPresent
        securityContext:
          runAsUser: 1000
          runAsGroup: 1000
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
        ports:
        - containerPort: 8080
        env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: NATS_URL
          value: "tls://nats.nats.svc.cluster.local:4222"
        - name: VAULT_AGENT_ADDR
          value: "http://127.0.0.1:8100"
        volumeMounts:
        - name: watcher-config
          mountPath: /app/config
          readOnly: true
        - name: nats-ca
          mountPath: "/app/certs/nats"
        - name: nats-client-certs
          mountPath: "/app/certs/nats-client"
        - name: avro-schemas
          mountPath: "/app/avro-schemas"
          readOnly: true
        - name: client-certs
          mountPath: "/app/certs/client"
        - name: watcher-bao-approle
          mountPath: "/app/bao/watcher"
        - name: watcher-bao-token
          mountPath: /home/bao/watcher
        - name: nats-bao-approle
          mountPath: "/app/bao/nats"
        - name: nats-bao-token
          mountPath: /home/bao/nats
