apiVersion: apps/v1
kind: Deployment
metadata:
  name: watcher
  labels:
    app: watcher
spec:
  replicas: 1
  selector:
    matchLabels:
      app: watcher
  template:
    metadata:
      labels:
        app: watcher
    spec:
      serviceAccountName: watcher-sa
      securityContext:
        runAsNonRoot: true
        fsGroup: 1000

      volumes:
      # Vault Authentication AppRole info
      - name: watcher-bao-approle
        projected:
          sources:
          - secret:
              name: watcher-bao-approle
              items:
              - key: role-id
                path: role-id
              - key: secret-id
                path: secret-id
      - name: watcher-bao-agent-config
        configMap:
          name: watcher-bao-agent-config
          items:
            - key: agent.hcl
              path: agent.hcl
      - name: watcher-bao-token
        emptyDir: {}
      - name: nats-bao-approle
        secret:
          secretName: nats-bao-approle
          items:
            - key: role-id
              path: role-id
            - key: secret-id
              path: secret-id
      - name: nats-bao-agent-config
        configMap:
          name: nats-bao-agent-config
          items:
            - key: agent.hcl
              path: agent.hcl
      - name: nats-bao-token
        emptyDir: {}
      - name: nats-bao-agent-cache
        emptyDir:
          sizeLimit: "50Mi"
      - name: watcher-bao-agent-cache
        emptyDir:
          sizeLimit: "50Mi"

      # CA bundle for client Vault TLS connection (Vault Agent uses)
      - name: openbao-ca
        projected:
          sources:
          - secret:
              name: openbao-ca-secret
              items:
              - key: ca.crt
                path: ca.crt

      - name: nats-ca-certs
        emptyDir: {}
  
      - name: nats-client-certs
        secret:
          secretName: "watcher-tls-credential"
          items:
          - key: tls.crt
            path: tls.crt
          - key: tls.key
            path: tls.key

      - name: watcher-config
        configMap:
          name: watcher-config

      - name: avro-schemas
        configMap:
          name: avro-schemas 

      - name: client-certs
        emptyDir: {}

      containers:
      - name: watcher-bao-agent
        image: openbao/openbao:latest  
        imagePullPolicy: IfNotPresent

        # Vault Agent runs as non-root
        securityContext:
          runAsUser: 1000
          runAsGroup: 1000
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL

        volumeMounts:
        - name: watcher-bao-approle
          mountPath: /etc/bao/watcher        # contains role-id & secret-id

        - name: watcher-bao-agent-config
          mountPath: /etc/bao-agent   # contains agent.hcl
          readOnly: true

        - name: openbao-ca
          mountPath: /etc/bao/ca
          readOnly: true

        - name: watcher-bao-token
          mountPath: /home/bao/watcher        # agent writes token here

        - name: watcher-bao-agent-cache
          mountPath: /home/bao/watcher/cache  # cache persistence directory

        command: ["bao", "agent", "-config=/etc/bao-agent/agent.hcl"]
        env:
        - name: VAULT_LOG_LEVEL
          value: "info"

      - name: nats-vault-agent
        image: openbao/openbao:latest
        imagePullPolicy: IfNotPresent

        # Bao Agent runs as non-root
        securityContext:
          runAsUser: 1000
          runAsGroup: 1000
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL

        volumeMounts:
        - name: nats-bao-approle
          mountPath: /etc/bao/nats
        - name: nats-bao-token
          mountPath: /home/bao/nats
        - name: nats-bao-agent-config
          mountPath: /etc/bao-agent
        - name: openbao-ca
          mountPath: /etc/bao/ca
        - name: nats-bao-agent-cache
          mountPath: /home/bao/nats/cache  # cache persistence directory

        command: ["bao", "agent", "-config=/etc/bao-agent/agent.hcl"]

      - name: watcher
        image: library/watcher:1.0
        imagePullPolicy: IfNotPresent
        securityContext:
          runAsUser: 1000
          runAsGroup: 1000
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
        env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        volumeMounts:
        - name: watcher-config
          mountPath: /app/config
          readOnly: true
        - name: nats-ca-certs
          mountPath: "/app/certs/nats-ca-certs"
        - name: nats-client-certs
          mountPath: "/app/certs/nats-client-certs"
        - name: openbao-ca
          mountPath: /app/openbao-ca
        - name: avro-schemas
          mountPath: "/app/avro-schemas"
          readOnly: true
        - name: client-certs
          mountPath: "/app/certs/client"
        - name: watcher-bao-approle
          mountPath: "/app/bao/watcher"
        - name: watcher-bao-token
          mountPath: /home/bao/watcher
        - name: nats-bao-approle
          mountPath: "/app/bao/nats"
        - name: nats-bao-token
          mountPath: /home/bao/nats
